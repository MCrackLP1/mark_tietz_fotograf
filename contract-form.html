<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertrag erstellen - Mark Tietz Fotografie</title>
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="assets/img/favicon/site.webmanifest">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* CSS Variables f√ºr bessere Lesbarkeit */
        :root {
            --color-primary: #1a202c;
            --color-primary-light: #2d3748;
            --color-secondary: #4a5568;
            --color-accent: #3182ce;
            --color-accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --color-text-primary: #1a202c;
            --color-text-secondary: #4a5568;
            --color-border: #e2e8f0;
            --color-background: #ffffff;
            --color-success: #38a169;
            --color-error: #e53e3e;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: var(--color-text-primary);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: var(--color-accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .header-text h1 {
            margin: 0;
            color: var(--color-primary);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .header-text p {
            margin: 0.25rem 0 0 0;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
        }

        .back-btn {
            background: var(--color-secondary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: opacity 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            opacity: 0.9;
        }

        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--color-border);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .form-section h3 {
            margin: 0 0 1rem 0;
            color: var(--color-primary);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: 400;
            font-size: 0.85rem;
        }

        .price-input {
            position: relative;
        }

        .price-input input {
            padding-right: 2rem;
        }

        .price-input::after {
            content: "‚Ç¨";
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
            pointer-events: none;
        }

        .generate-btn {
            width: 100%;
            padding: 1rem;
            background: var(--color-accent-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 1rem;
        }

        .generate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading-text {
            display: none;
        }

        .pdf-actions {
            display: none;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 2rem;
            border-radius: 16px;
            margin-top: 1rem;
            text-align: center;
            border: 1px solid rgba(59, 130, 246, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .pdf-actions.show {
            display: block;
        }

        .pdf-actions p {
            color: var(--color-primary);
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        .pdf-btn {
            background: var(--color-success);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            margin: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pdf-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.15);
        }

        .pdf-btn:active {
            transform: translateY(0);
        }

        .pdf-btn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .contract-preview {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            border: 1px dashed var(--color-border);
            text-align: center;
            color: var(--color-text-secondary);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .pdf-btn-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .pdf-btn {
                justify-content: center;
                width: 100%;
            }

            .pdf-actions {
                padding: 1.5rem;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-primary: #ffffff;
                --color-text-primary: #ffffff;
                --color-text-secondary: #cbd5e0;
                --color-border: #4a5568;
                --color-background: #2d3748;
            }

            body {
                background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
                color: var(--color-text-primary);
            }

            .form-container, .header {
                background: #2d3748;
                color: var(--color-text-primary);
            }

            input, select, textarea {
                background: #4a5568;
                color: var(--color-text-primary);
                border-color: var(--color-border);
            }

            .contract-preview {
                background: #4a5568;
                color: var(--color-text-secondary);
            }

            .pdf-actions {
                background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
                border: 1px solid #4a5568;
                color: var(--color-text-primary);
            }

            .pdf-actions p {
                color: var(--color-text-primary);
            }

            .pdf-btn {
                box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            }

            .pdf-btn:hover {
                box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.4);
            }
        }

        /* PDF styles - hidden from screen */
        .pdf-content {
            display: none;
            background: white;
            padding: 40px 40px 50px 40px; /* Extra bottom padding for footer space */
            font-family: Arial, sans-serif;
            font-size: 11px;
            line-height: 1.4;
            color: #333;
            width: 210mm;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .pdf-page {
            min-height: 240mm; /* A4 height minus space for jsPDF footer */
            page-break-after: always;
            padding-bottom: 30px;
            position: relative;
        }

        .pdf-page:last-child {
            page-break-after: auto;
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
            page-break-after: avoid;
        }

        .pdf-logo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pdf-company-info {
            text-align: right;
            font-size: 10px;
        }

        .pdf-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 30px 0;
            color: #333;
            page-break-after: avoid;
        }

        .pdf-section {
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .pdf-section.allow-break {
            page-break-inside: auto;
        }

        .pdf-section h4 {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
            page-break-after: avoid;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .pdf-table.allow-break {
            page-break-inside: auto;
        }

        .pdf-table th,
        .pdf-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .pdf-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .pdf-footer {
            /* Footer wird nur √ºber jsPDF hinzugef√ºgt, nicht im HTML */
            display: none;
        }

        .page-break {
            page-break-before: always;
        }

        .no-break {
            page-break-inside: avoid;
        }

        .signature-section {
            margin-top: 40px;
            page-break-inside: avoid;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <div class="logo">
                    <img src="assets/img/favicon/android-chrome-192x192.png" alt="Mark Tietz Logo" />
                </div>
                <div class="header-text">
                    <h1 id="contractTitle">Vertrag erstellen</h1>
                    <p>Bitte f√ºllen Sie alle Felder sorgf√§ltig aus</p>
                </div>
            </div>
            <a href="admin-contracts.html" class="back-btn">‚Üê Zur√ºck</a>
        </div>

        <div class="form-container">
            <form id="contractForm">
                <!-- Kunde/Model Daten -->
                <div class="form-section">
                    <h3>üë§ Kunde / Model Daten</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientFirstName">Vorname *</label>
                            <input type="text" id="clientFirstName" name="clientFirstName" required maxlength="30">
                        </div>
                        <div class="form-group">
                            <label for="clientLastName">Nachname *</label>
                            <input type="text" id="clientLastName" name="clientLastName" required maxlength="30">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientEmail">E-Mail *</label>
                            <input type="email" id="clientEmail" name="clientEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">Telefon</label>
                            <input type="tel" id="clientPhone" name="clientPhone" maxlength="20">
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="clientAddress">Adresse *</label>
                        <textarea id="clientAddress" name="clientAddress" required maxlength="200" placeholder="Stra√üe, Hausnummer, PLZ, Ort"></textarea>
                    </div>
                </div>

                <!-- Shooting Details -->
                <div class="form-section">
                    <h3>üìÖ Shooting Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shootingDate">Datum *</label>
                            <input type="date" id="shootingDate" name="shootingDate" required>
                        </div>
                        <div class="form-group">
                            <label for="shootingTime">Uhrzeit</label>
                            <input type="time" id="shootingTime" name="shootingTime">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="duration">Dauer (Stunden)</label>
                            <select id="duration" name="duration">
                                <option value="1">1 Stunde</option>
                                <option value="2">2 Stunden</option>
                                <option value="3">3 Stunden</option>
                                <option value="4">4 Stunden</option>
                                <option value="6">6 Stunden</option>
                                <option value="8">8 Stunden</option>
                                <option value="custom">Individuell</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="location">Location *</label>
                            <input type="text" id="location" name="location" required maxlength="100" placeholder="Studio, Outdoor, Adresse...">
                        </div>
                    </div>
                </div>

                <!-- Vertragsspezifische Felder -->
                <div class="form-section" id="contractSpecific">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>

                <!-- Konditionen -->
                <div class="form-section">
                    <h3>üí∞ Konditionen</h3>
                    <div class="form-row" id="priceSection">
                        <div class="form-group">
                            <label for="totalPrice">Gesamtpreis</label>
                            <div class="price-input">
                                <input type="number" id="totalPrice" name="totalPrice" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Zahlungsweise</label>
                            <select id="paymentMethod" name="paymentMethod">
                                <option value="cash">Bar</option>
                                <option value="transfer">√úberweisung</option>
                                <option value="partial">Teilzahlung</option>
                                <option value="tfp">TFP (kostenfrei)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Zusatzleistungen</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="extraServices" value="stylist">
                                <label>Stylistin (95 ‚Ç¨)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="extraServices" value="videographer">
                                <label>Videograf (Levin Dumlu / LDK Films - Preis auf Anfrage)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="extraServices" value="express">
                                <label>Expresslieferung (120 ‚Ç¨)</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="additionalCosts">Zus√§tzliche Kosten / Anmerkungen</label>
                        <textarea id="additionalCosts" name="additionalCosts" maxlength="300" placeholder="z.B. spezielle W√ºnsche, besondere Anforderungen..."></textarea>
                    </div>
                </div>

                <!-- Zus√§tzliche Vereinbarungen -->
                <div class="form-section">
                    <h3>üìù Zus√§tzliche Vereinbarungen</h3>
                    <div class="form-group">
                        <label for="additionalNotes">Besondere W√ºnsche / Vereinbarungen</label>
                        <textarea id="additionalNotes" name="additionalNotes" maxlength="500" placeholder="Individuelle W√ºnsche, besondere Anforderungen, etc."></textarea>
                    </div>
                </div>

                <div class="contract-preview">
                    <p>üìã Nach dem Ausf√ºllen wird Ihr professioneller Vertrag als PDF generiert</p>
                </div>

                <button type="submit" class="generate-btn" id="generateBtn">
                    <span class="default-text">PDF Vertrag erstellen</span>
                    <span class="loading-text">PDF wird erstellt...</span>
                </button>

                <div class="pdf-actions" id="pdfActions">
                    <p><strong>‚úÖ PDF erfolgreich erstellt!</strong></p>
                    <div class="pdf-btn-grid">
                        <button type="button" class="pdf-btn" onclick="downloadPDF()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="currentColor" stroke-width="2"/>
                                <polyline points="7,10 12,15 17,10" stroke="currentColor" stroke-width="2"/>
                                <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            PDF herunterladen
                        </button>
                        <button type="button" class="pdf-btn" onclick="openPDFInNewTab()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M15 3h6v6" stroke="currentColor" stroke-width="2"/>
                                <path d="m21 3-6 6" stroke="currentColor" stroke-width="2"/>
                                <path d="M14 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-9" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            In neuem Tab √∂ffnen
                        </button>
                        <button type="button" class="pdf-btn" onclick="copyPDFLink()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2"/>
                                <path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            Link kopieren
                        </button>
                        <button type="button" class="pdf-btn" onclick="createNewContract()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <line x1="12" y1="8" x2="12" y2="16" stroke="currentColor" stroke-width="2"/>
                                <line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            Neuen Vertrag erstellen
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- PDF Content (hidden) -->
    <div class="pdf-content" id="pdfContent">
        <!-- PDF content will be generated here -->
    </div>

    <script>
        // Pr√ºfung ob eingeloggt
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'admin-login.html';
        }

        // Contract type from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const contractType = urlParams.get('type') || 'tfp';
        let contractData = {};
        let pdfBlob = null;

        // Contract configurations
        const contractConfigs = {
            tfp: {
                title: 'TFP Vertrag (Time for Print)',
                icon: 'üì∏',
                specificFields: `
                    <h3>üì∏ TFP Vereinbarung</h3>
                    <div class="form-group">
                        <label>Bildanzahl f√ºr Model *</label>
                        <select name="imageCount" required>
                            <option value="">Ausw√§hlen...</option>
                            <option value="5">5 bearbeitete Bilder</option>
                            <option value="10">10 bearbeitete Bilder</option>
                            <option value="15">15 bearbeitete Bilder</option>
                            <option value="20">20 bearbeitete Bilder</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nutzungsrechte Model</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="modelRights" value="social">
                                <label>Social Media (privat)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="modelRights" value="portfolio">
                                <label>Portfolio/Sedcard</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="modelRights" value="commercial">
                                <label>Kommerzielle Nutzung</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nutzungsrechte Fotograf</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="photographerRights" value="portfolio" checked>
                                <label>Portfolio</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="photographerRights" value="social">
                                <label>Social Media</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="photographerRights" value="website">
                                <label>Website</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="photographerRights" value="marketing">
                                <label>Marketing/Werbung</label>
                            </div>
                        </div>
                    </div>
                `
            },
            wedding: {
                title: 'Hochzeitsvertrag',
                icon: 'üíí',
                specificFields: `
                    <h3>üíí Hochzeitsdetails</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="partnerName">Partner/in Name</label>
                            <input type="text" name="partnerName" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="weddingVenue">Hochzeitslocation *</label>
                            <input type="text" name="weddingVenue" required maxlength="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Leistungspaket *</label>
                        <select name="weddingPackage" required>
                            <option value="">Ausw√§hlen...</option>
                            <option value="basic">Basic (4h, 50 Bilder)</option>
                            <option value="standard">Standard (6h, 100 Bilder)</option>
                            <option value="premium">Premium (8h, alle Bilder)</option>
                            <option value="custom">Individuell</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Zus√§tzliche Services</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="weddingExtras" value="engagement">
                                <label>Verlobungsshooting</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="weddingExtras" value="album">
                                <label>Hochzeitsalbum</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="weddingExtras" value="drone">
                                <label>Drohnenaufnahmen</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="weddingExtras" value="video">
                                <label>Videografie</label>
                            </div>
                        </div>
                    </div>
                `
            },
            business: {
                title: 'Business Shooting Vertrag',
                icon: 'üíº',
                specificFields: `
                    <h3>üíº Business Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyName">Unternehmen</label>
                            <input type="text" name="companyName" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="businessType">Art des Shootings *</label>
                            <select name="businessType" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="headshots">Mitarbeiterportraits</option>
                                <option value="corporate">Corporate Shooting</option>
                                <option value="products">Produktfotografie</option>
                                <option value="events">Firmenevents</option>
                                <option value="architecture">Architektur</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nutzungsrechte *</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="businessRights" value="website" required>
                                <label>Website</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="businessRights" value="social">
                                <label>Social Media</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="businessRights" value="print">
                                <label>Printmedien</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="businessRights" value="advertising">
                                <label>Werbung</label>
                            </div>
                        </div>
                    </div>
                `
            },
            portrait: {
                title: 'Portrait Shooting Vertrag',
                icon: 'üë§',
                specificFields: `
                    <h3>üë§ Portrait Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="portraitType">Art des Portraits *</label>
                            <select name="portraitType" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="individual">Einzelportrait</option>
                                <option value="couple">Paarportrait</option>
                                <option value="group">Gruppenportrait</option>
                                <option value="family">Familienportrait</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="portraitStyle">Stil *</label>
                            <select name="portraitStyle" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="studio">Studio</option>
                                <option value="outdoor">Outdoor</option>
                                <option value="lifestyle">Lifestyle</option>
                                <option value="classic">Klassisch</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="imageDelivery">Bildlieferung *</label>
                        <select name="imageDelivery" required>
                            <option value="">Ausw√§hlen...</option>
                            <option value="digital">Digital (Download-Link)</option>
                            <option value="usb">USB-Stick</option>
                            <option value="prints">Prints + Digital</option>
                        </select>
                    </div>
                `
            },
            event: {
                title: 'Event Fotografie Vertrag',
                icon: 'üéâ',
                specificFields: `
                    <h3>üéâ Event Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventType">Art der Veranstaltung *</label>
                            <select name="eventType" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="party">Private Feier</option>
                                <option value="corporate">Firmenevent</option>
                                <option value="conference">Konferenz</option>
                                <option value="concert">Konzert/Show</option>
                                <option value="sport">Sportevent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="guestCount">Anzahl G√§ste (ca.)</label>
                            <input type="number" name="guestCount" min="1" max="1000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Besondere Anforderungen</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="eventExtras" value="discrete">
                                <label>Diskrete Arbeitsweise</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="eventExtras" value="flash">
                                <label>Blitzlicht erlaubt</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="eventExtras" value="livestream">
                                <label>Live-√úbertragung</label>
                            </div>
                        </div>
                    </div>
                `
            },
            family: {
                title: 'Familien Shooting Vertrag',
                icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                specificFields: `
                    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familien Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="familySize">Anzahl Personen *</label>
                            <select name="familySize" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="2">2 Personen</option>
                                <option value="3">3 Personen</option>
                                <option value="4">4 Personen</option>
                                <option value="5">5 Personen</option>
                                <option value="6+">6+ Personen</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="childrenAges">Alter der Kinder</label>
                            <input type="text" name="childrenAges" maxlength="50" placeholder="z.B. 3, 7, 12 Jahre">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="familyStyle">Shooting-Stil *</label>
                        <select name="familyStyle" required>
                            <option value="">Ausw√§hlen...</option>
                            <option value="natural">Nat√ºrlich/Spontan</option>
                            <option value="posed">Gestellt/Formal</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="playful">Verspielt/Kreativ</option>
                        </select>
                    </div>
                `
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeContractForm();
        });

        function initializeContractForm() {
            const config = contractConfigs[contractType];
            if (!config) {
                alert('Unbekannter Vertragstyp');
                window.location.href = 'admin-contracts.html';
                return;
            }

            // Update page title and header
            document.getElementById('contractTitle').innerHTML = `${config.icon} ${config.title}`;
            document.title = `${config.title} - Mark Tietz Fotografie`;

            // Insert specific form fields
            document.getElementById('contractSpecific').innerHTML = config.specificFields;

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('shootingDate').setAttribute('min', today);

            // Handle TFP price hiding
            if (contractType === 'tfp') {
                document.getElementById('priceSection').style.display = 'none';
            }
        }

        // Form submission
        document.getElementById('contractForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generatePDF();
        });

        function generatePDF() {
            const btn = document.getElementById('generateBtn');
            const defaultText = btn.querySelector('.default-text');
            const loadingText = btn.querySelector('.loading-text');

            // Show loading state
            btn.disabled = true;
            defaultText.style.display = 'none';
            loadingText.style.display = 'inline';

            // Collect form data
            const formData = new FormData(document.getElementById('contractForm'));
            contractData = Object.fromEntries(formData.entries());

            // Collect checkbox groups
            const checkboxGroups = ['modelRights', 'photographerRights', 'weddingExtras', 'businessRights', 'eventExtras', 'extraServices'];
            checkboxGroups.forEach(group => {
                const checkboxes = document.querySelectorAll(`input[name="${group}"]:checked`);
                contractData[group] = Array.from(checkboxes).map(cb => cb.value);
            });

            // Generate PDF content
            setTimeout(() => {
                try {
                    createPDFContent();
                    generatePDFFile();
                    
                    // Show success state
                    defaultText.style.display = 'inline';
                    loadingText.style.display = 'none';
                    btn.disabled = false;
                    
                    document.getElementById('pdfActions').classList.add('show');
                } catch (error) {
                    console.error('PDF generation error:', error);
                    alert('Fehler beim Erstellen der PDF. Bitte versuchen Sie es erneut.');
                    
                    defaultText.style.display = 'inline';
                    loadingText.style.display = 'none';
                    btn.disabled = false;
                }
            }, 1500);
        }

        function createPDFContent() {
            const config = contractConfigs[contractType];
            const currentDate = new Date().toLocaleDateString('de-DE');
            
            let specificContent = '';
            
            // Generate type-specific content
            switch(contractType) {
                case 'tfp':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>TFP Vereinbarung</h4>
                            <p><strong>Bildanzahl f√ºr Model:</strong> ${contractData.imageCount} bearbeitete Bilder</p>
                            <p><strong>Nutzungsrechte Model:</strong> ${contractData.modelRights ? contractData.modelRights.join(', ') : 'Keine ausgew√§hlt'}</p>
                            <p><strong>Nutzungsrechte Fotograf:</strong> ${contractData.photographerRights ? contractData.photographerRights.join(', ') : 'Portfolio'}</p>
                        </div>
                    `;
                    break;
                case 'wedding':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Hochzeitsdetails</h4>
                            <p><strong>Partner/in:</strong> ${contractData.partnerName || 'Nicht angegeben'}</p>
                            <p><strong>Hochzeitslocation:</strong> ${contractData.weddingVenue}</p>
                            <p><strong>Leistungspaket:</strong> ${contractData.weddingPackage}</p>
                            <p><strong>Zus√§tzliche Services:</strong> ${contractData.weddingExtras ? contractData.weddingExtras.join(', ') : 'Keine'}</p>
                        </div>
                    `;
                    break;
                case 'business':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Business Details</h4>
                            <p><strong>Unternehmen:</strong> ${contractData.companyName || 'Nicht angegeben'}</p>
                            <p><strong>Art des Shootings:</strong> ${contractData.businessType}</p>
                            <p><strong>Nutzungsrechte:</strong> ${contractData.businessRights ? contractData.businessRights.join(', ') : 'Keine ausgew√§hlt'}</p>
                        </div>
                    `;
                    break;
                case 'portrait':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Portrait Details</h4>
                            <p><strong>Art des Portraits:</strong> ${contractData.portraitType}</p>
                            <p><strong>Stil:</strong> ${contractData.portraitStyle}</p>
                            <p><strong>Bildlieferung:</strong> ${contractData.imageDelivery}</p>
                        </div>
                    `;
                    break;
                case 'event':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Event Details</h4>
                            <p><strong>Art der Veranstaltung:</strong> ${contractData.eventType}</p>
                            <p><strong>Anzahl G√§ste:</strong> ${contractData.guestCount || 'Nicht angegeben'}</p>
                            <p><strong>Besondere Anforderungen:</strong> ${contractData.eventExtras ? contractData.eventExtras.join(', ') : 'Keine'}</p>
                        </div>
                    `;
                    break;
                case 'family':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Familien Details</h4>
                            <p><strong>Anzahl Personen:</strong> ${contractData.familySize}</p>
                            <p><strong>Alter der Kinder:</strong> ${contractData.childrenAges || 'Nicht angegeben'}</p>
                            <p><strong>Shooting-Stil:</strong> ${contractData.familyStyle}</p>
                        </div>
                    `;
                    break;
            }

            const pdfContent = `
                <div class="pdf-header">
                    <div>
                        <div class="pdf-logo">
                            <img src="assets/img/favicon/android-chrome-192x192.png" alt="Mark Tietz Fotografie Logo" />
                        </div>
                    </div>
                    <div class="pdf-company-info">
                        <strong>Mark Tietz Fotograf</strong><br>
                        K√∂nigplatz 3<br>
                        87448 Waltenhofen<br><br>
                        Tel: +49 174 1632129<br>
                        E-Mail: info@mark-tietz.photos<br>
                        Web: www.mark-tietz.photos<br><br>
                        Inhaber: Mark Tietz<br>
                        Geb.: 25. Januar 1997<br>
                        Verf√ºgbarkeit: 24/7 nach Vereinbarung
                    </div>
                </div>

                <div class="pdf-title">${config.title}</div>

                <div class="pdf-section">
                    <h4>Kundendaten</h4>
                    <p><strong>Name:</strong> ${contractData.clientFirstName} ${contractData.clientLastName}</p>
                    <p><strong>E-Mail:</strong> ${contractData.clientEmail}</p>
                    <p><strong>Telefon:</strong> ${contractData.clientPhone || 'Nicht angegeben'}</p>
                    <p><strong>Adresse:</strong> ${contractData.clientAddress}</p>
                </div>

                <div class="pdf-section">
                    <h4>Shooting Details</h4>
                    <table class="pdf-table">
                        <tr>
                            <td><strong>Datum:</strong></td>
                            <td>${new Date(contractData.shootingDate).toLocaleDateString('de-DE')}</td>
                        </tr>
                        <tr>
                            <td><strong>Uhrzeit:</strong></td>
                            <td>${contractData.shootingTime || 'Nach Vereinbarung'}</td>
                        </tr>
                        <tr>
                            <td><strong>Dauer:</strong></td>
                            <td>${contractData.duration} Stunde(n)</td>
                        </tr>
                        <tr>
                            <td><strong>Location:</strong></td>
                            <td>${contractData.location}</td>
                        </tr>
                    </table>
                </div>

                ${specificContent}

                ${contractType !== 'tfp' ? `
                <div class="pdf-section">
                    <h4>Preise und Zahlungsbedingungen</h4>
                    <table class="pdf-table allow-break">
                        <tr>
                            <td><strong>Leistung:</strong></td>
                            <td>${getServiceDescription(contractType)}</td>
                        </tr>
                        <tr>
                            <td><strong>Gesamtpreis:</strong></td>
                            <td>${contractData.totalPrice ? contractData.totalPrice + ' ‚Ç¨' : getServicePrice(contractType)}</td>
                        </tr>
                        <tr>
                            <td><strong>Zahlungsweise:</strong></td>
                            <td><strong>Zahlung im Voraus erforderlich</strong><br>${getPaymentMethodText(contractData.paymentMethod)}</td>
                        </tr>
                    </table>
                    ${contractData.extraServices && contractData.extraServices.length > 0 ? `
                    <h4 style="margin-top: 15px;">Zusatzleistungen</h4>
                    <ul style="font-size: 9px; margin: 0; padding-left: 15px;">
                        ${contractData.extraServices.map(service => {
                            const serviceTexts = {
                                'stylist': 'Stylistin: 95 ‚Ç¨',
                                'videographer': 'Videograf (Levin Dumlu / LDK Films): Preis auf Anfrage',
                                'express': 'Expresslieferung: 120 ‚Ç¨'
                            };
                            return `<li>${serviceTexts[service] || service}</li>`;
                        }).join('')}
                    </ul>
                    ` : ''}
                    ${contractData.additionalCosts ? `<p><strong>Weitere Anmerkungen:</strong> ${contractData.additionalCosts}</p>` : ''}
                    
                    <h4 style="margin-top: 20px;">Bankverbindung</h4>
                    <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 9px;">
                        <strong>Bank√ºberweisung:</strong><br>
                        IBAN: DE56 1001 0010 0776 3691 14<br>
                        Bank: Postbank<br>
                        Inhaber: Mark Tietz<br><br>
                        <strong>PayPal:</strong> Link mit Betrag wird bei Buchung versendet
                    </p>
                    
                    <h4 style="margin-top: 15px;">Reisegeb√ºhren</h4>
                    <p style="font-size: 9px;">
                        Bei Shootings unter 250 ‚Ç¨: Ab 30 km Entfernung 10 ‚Ç¨ je weitere 10 km
                    </p>
                </div>
                ` : ''}

                ${contractData.additionalNotes ? `
                <div class="pdf-section">
                    <h4>Zus√§tzliche Vereinbarungen</h4>
                    <p>${contractData.additionalNotes}</p>
                </div>
                ` : ''}

                <div class="pdf-section">
                    <h4>Stornierungsbedingungen</h4>
                    <table class="pdf-table" style="font-size: 8px;">
                        <thead>
                            <tr>
                                <th>Vorlauf</th>
                                <th>Mo.‚ÄìFr.</th>
                                <th>Sa./So.</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>&gt; 5 Tage</td><td>0%</td><td>0%</td></tr>
                            <tr><td>5 Tage</td><td>0%</td><td>20%</td></tr>
                            <tr><td>4 Tage</td><td>0%</td><td>35%</td></tr>
                            <tr><td>3 Tage</td><td>15%</td><td>45%</td></tr>
                            <tr><td>2 Tage</td><td>30%</td><td>60%</td></tr>
                            <tr><td>1 Tag</td><td>50%</td><td>70%</td></tr>
                            <tr><td>0 Tage</td><td>75%</td><td>75%</td></tr>
                        </tbody>
                    </table>
                </div>
                    
                <div class="pdf-section">
                    <h4>Lieferzeiten</h4>
                    <p style="font-size: 9px;">
                        <strong>Standardlieferung:</strong> ca. 6 Tage<br>
                        <strong>Expresslieferung:</strong> gegen Aufpreis von 120 ‚Ç¨
                    </p>
                </div>

                    <h4 style="margin-top: 15px;">Allgemeine Gesch√§ftsbedingungen</h4>
                    <div class="pdf-section allow-break" style="font-size: 9px; line-height: 1.4;">
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>1. Vertragspartner:</strong> Dieser Vertrag regelt die Zusammenarbeit zwischen Mark Tietz Fotograf und dem oben genannten Kunden.
                        </div>
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>2. Terminvereinbarung:</strong> Bei Hochzeiten mindestens 1 Woche Vorlauf (Ausnahmen nach Absprache m√∂glich).
                        </div>
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>3. H√∂here Gewalt:</strong> Bei Ausfall durch h√∂here Gewalt (Wetter, Krankheit) wird ein Ersatztermin vereinbart.
                        </div>
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>4. Bildbearbeitung:</strong> Erfolgt nach k√ºnstlerischem Ermessen des Fotografen. Kundenkontakt w√§hrend Bearbeitung pers√∂nlich durch Mark Tietz.
                        </div>
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>5. Nutzungsrechte:</strong> Werden gem√§√ü den oben vereinbarten Bedingungen √ºbertragen.
                        </div>
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>6. Werbezwecke:</strong> Der Fotograf beh√§lt sich das Recht vor, Bilder f√ºr eigene Werbezwecke zu verwenden, sofern nicht anders vereinbart.
                        </div>
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>7. Nachbesserungen:</strong> R√ºckmeldungen und Nachbesserungen sind nach individueller Absprache m√∂glich.
                        </div>
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>8. Verf√ºgbarkeit:</strong> 24/7 nach Vereinbarung. Besondere Kundenw√ºnsche nur nach Absprache.
                        </div>
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>9. Haftung:</strong> Die Haftung beschr√§nkt sich auf den Auftragswert. Weitergehende Anspr√ºche sind ausgeschlossen.
                        </div>
                        <div class="no-break" style="margin-bottom: 8px;">
                            <strong>10. Gerichtsstand:</strong> Erf√ºllungsort und Gerichtsstand ist Waltenhofen.
                        </div>
                    </div>
                </div>

                <div class="signature-section">
                    <table style="width: 100%;">
                        <tr>
                            <td style="width: 50%; border-top: 1px solid #333; text-align: center; padding-top: 5px;">
                                <small>Datum, Unterschrift Kunde</small>
                            </td>
                            <td style="width: 50%; border-top: 1px solid #333; text-align: center; padding-top: 5px;">
                                <small>Datum, Unterschrift Mark Tietz</small>
                            </td>
                        </tr>
                    </table>
                </div>
            `;

            document.getElementById('pdfContent').innerHTML = pdfContent;
        }

        function generatePDFFile() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const element = document.getElementById('pdfContent');
            element.style.display = 'block';

            // Better PDF generation with proper page breaks
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                logging: false,
                imageTimeout: 10000,
                removeContainer: true,
                height: element.scrollHeight,
                windowWidth: 1200
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 270; // Reduced to leave space for footer
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                let heightLeft = imgHeight;
                let position = 0;
                let pageNumber = 1;
                
                // Add first page
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                
                // Add footer to first page
                addFooterToPage(pdf, pageNumber);
                
                heightLeft -= pageHeight;
                
                // Add additional pages if needed
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pageNumber++;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    
                    // Add footer to each page
                    addFooterToPage(pdf, pageNumber);
                    
                    heightLeft -= pageHeight;
                }

                // Generate blob for download
                pdfBlob = pdf.output('blob');
                
                element.style.display = 'none';
            }).catch(error => {
                console.error('PDF generation failed:', error);
                element.style.display = 'none';
                throw error;
            });
        }

        function addFooterToPage(pdf, pageNumber) {
            const pageHeight = 297;
            const footerStartY = pageHeight - 20; // 20mm from bottom for more space
            
            // Footer line
            pdf.setDrawColor(221, 221, 221);
            pdf.setLineWidth(0.1);
            pdf.line(15, footerStartY, 195, footerStartY);
            
            // Footer text
            pdf.setFontSize(7);
            pdf.setTextColor(102, 102, 102);
            
            const footerText = [
                'Mark Tietz Fotograf | K√∂nigplatz 3, 87448 Waltenhofen | Tel: +49 174 1632129 | info@mark-tietz.photos',
                'Website: www.mark-tietz.photos | Inhaber: Mark Tietz (geb. 25. Januar 1997)',
                'Bankverbindung: Postbank | IBAN: DE56 1001 0010 0776 3691 14 | Verf√ºgbarkeit: 24/7 nach Vereinbarung',
                `Seite ${pageNumber} | Erstellt am: ${new Date().toLocaleDateString('de-DE')}`
            ];
            
            let yOffset = footerStartY + 3;
            footerText.forEach(line => {
                pdf.text(line, 105, yOffset, { align: 'center' });
                yOffset += 2.5;
            });
        }

        function getPaymentMethodText(method) {
            const methods = {
                'cash': 'Bar',
                'transfer': '√úberweisung',
                'partial': 'Teilzahlung',
                'tfp': 'TFP (kostenfrei)'
            };
            return methods[method] || method;
        }

        function getServiceDescription(contractType) {
            const descriptions = {
                'wedding': 'Hochzeitsfotografie',
                'business': 'Business- und Bewerbungsfotos',
                'portrait': 'Portr√§t- und Familienfotografie',
                'event': 'Eventfotografie',
                'family': 'Baby- und Schwangerschaftsfotografie'
            };
            return descriptions[contractType] || 'Fotografie-Dienstleistung';
        }

        function getServicePrice(contractType) {
            const prices = {
                'wedding': '1.000 ‚Ç¨ - 1.600 ‚Ç¨ (je nach Dauer und Zusatzleistungen)',
                'business': '80 ‚Ç¨ - 96 ‚Ç¨ pro Session',
                'portrait': '180 ‚Ç¨ - 240 ‚Ç¨ (einst√ºndige Shootings, inklusive digitaler Bilder)',
                'event': '80 ‚Ç¨ - 96 ‚Ç¨ pro Stunde',
                'family': '180 ‚Ç¨ - 240 ‚Ç¨ pro Stunde'
            };
            return prices[contractType] || 'Nach Vereinbarung';
        }

        function copyPDFLink() {
            if (pdfBlob) {
                // Option 1: Upload to cloud storage for permanent sharing
                uploadPDFToCloud(pdfBlob).then(shareableUrl => {
                    if (shareableUrl) {
                        navigator.clipboard.writeText(shareableUrl).then(() => {
                            alert(`‚úÖ √ñffentlicher PDF-Link wurde kopiert!\n\nDieser Link kann geteilt werden und ist ohne Passwort zug√§nglich:\n${shareableUrl}\n\nDie PDF ist 30 Tage verf√ºgbar.`);
                        }).catch(() => {
                            prompt('√ñffentlicher PDF-Link (Strg+C zum Kopieren):', shareableUrl);
                        });
                    } else {
                        // Fallback: Download-Option anbieten
                        alert('‚ö†Ô∏è Cloud-Upload nicht verf√ºgbar.\nBitte verwenden Sie "PDF herunterladen" und senden Sie die Datei direkt.');
                    }
                }).catch(error => {
                    console.error('Upload error:', error);
                    // Fallback: Anleitung f√ºr manuellen Versand
                    alert('‚ö†Ô∏è Cloud-Upload fehlgeschlagen.\n\nF√ºr das Teilen der PDF:\n1. "PDF herunterladen" klicken\n2. Datei per E-Mail oder anderweitig versenden\n3. Oder einen Cloud-Speicher (Google Drive, Dropbox) verwenden');
                });
            } else {
                alert('‚ùå Fehler: PDF noch nicht generiert. Bitte erstellen Sie zuerst eine PDF.');
            }
        }

        // Cloud Upload Funktion - implementiert verschiedene Services
        async function uploadPDFToCloud(pdfBlob) {
            try {
                // Option 1: TempFile Service (24h verf√ºgbar)
                return await uploadToTempFileService(pdfBlob);
                
            } catch (error) {
                console.error('TempFile upload failed:', error);
                
                try {
                    // Option 2: Alternative Service
                    return await uploadToAlternativeService(pdfBlob);
                } catch (alternativeError) {
                    console.error('Alternative upload failed:', alternativeError);
                    return null;
                }
            }
        }

        // TempFile.io Upload (kostenlos, 24h verf√ºgbar)
        async function uploadToTempFileService(pdfBlob) {
            const formData = new FormData();
            const fileName = `Vertrag_${contractData.clientLastName}_${new Date().toISOString().split('T')[0]}.pdf`;
            formData.append('file', pdfBlob, fileName);

            const response = await fetch('https://tmpfiles.org/api/v1/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Upload failed');
            
            const result = await response.json();
            
            // TempFiles returns a URL that needs to be modified for direct access
            if (result.data && result.data.url) {
                // Convert from view URL to direct download URL
                const directUrl = result.data.url.replace('https://tmpfiles.org/', 'https://tmpfiles.org/dl/');
                return directUrl;
            }
            
            throw new Error('No URL received');
        }

        // Alternative Service: File.io (kostenlos, einmalig)
        async function uploadToAlternativeService(pdfBlob) {
            const formData = new FormData();
            const fileName = `Vertrag_${contractData.clientLastName}_${new Date().toISOString().split('T')[0]}.pdf`;
            formData.append('file', pdfBlob, fileName);

            const response = await fetch('https://file.io', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Alternative upload failed');
            
            const result = await response.json();
            
            if (result.success && result.link) {
                return result.link;
            }
            
            throw new Error('No URL received from alternative service');
        }

        // Erweiterte Funktion f√ºr bessere Download-Verwaltung
        function downloadPDF() {
            if (pdfBlob) {
                const link = document.createElement('a');
                const fileName = `Vertrag_${contractData.clientLastName}_${new Date().toISOString().split('T')[0]}.pdf`;
                link.href = URL.createObjectURL(pdfBlob);
                link.download = fileName;
                
                // F√ºr bessere UX: Download-Status anzeigen
                const originalText = document.querySelector('#pdfActions p').innerHTML;
                document.querySelector('#pdfActions p').innerHTML = '<strong>üì• Download wird vorbereitet...</strong>';
                
                setTimeout(() => {
                    link.click();
                    document.querySelector('#pdfActions p').innerHTML = originalText;
                    
                    // Hinweis f√ºr Sharing anzeigen
                    setTimeout(() => {
                        if (confirm('üí° Tipp: F√ºr das einfache Teilen der PDF k√∂nnen Sie diese in einen Cloud-Speicher (Google Drive, Dropbox, etc.) hochladen und den Link teilen.\n\nSoll ich Ihnen dabei helfen?')) {
                            showSharingHelp();
                        }
                    }, 1000);
                }, 100);
            }
        }

        // Hilfe f√ºr manuelles Sharing
        function showSharingHelp() {
            const helpText = `
üì§ So teilen Sie die PDF einfach:

1. **Google Drive:**
   - drive.google.com √∂ffnen
   - PDF hochladen
   - Rechtsklick ‚Üí "Link abrufen"
   - Freigabe auf "Jeder mit dem Link" setzen

2. **Dropbox:**
   - dropbox.com √∂ffnen  
   - PDF hochladen
   - "Teilen" klicken ‚Üí Link kopieren

3. **WeTransfer:**
   - wetransfer.com √∂ffnen
   - PDF hochladen
   - Link per E-Mail versenden

4. **E-Mail-Anhang:**
   - PDF direkt als Anhang versenden
   - Bei gr√∂√üeren Dateien ZIP-Komprimierung verwenden
            `;
            
            alert(helpText);
        }

        function openPDFInNewTab() {
            if (pdfBlob) {
                const dataUrl = URL.createObjectURL(pdfBlob);
                window.open(dataUrl, '_blank');
            } else {
                alert('‚ùå Fehler: PDF noch nicht generiert. Bitte erstellen Sie zuerst eine PDF.');
            }
        }

        function createNewContract() {
            if (confirm('M√∂chten Sie wirklich einen neuen Vertrag erstellen? Alle aktuellen Eingaben gehen verloren.')) {
                window.location.reload();
            }
        }
    </script>
</body>
</html> 