<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertrag erstellen - Mark Tietz Fotografie</title>
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="assets/img/favicon/site.webmanifest">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: var(--color-accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .header-text h1 {
            margin: 0;
            color: var(--color-primary);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .header-text p {
            margin: 0.25rem 0 0 0;
            color: var(--color-text-secondary);
            font-size: 0.85rem;
        }

        .back-btn {
            background: var(--color-secondary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: opacity 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            opacity: 0.9;
        }

        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--color-border);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .form-section h3 {
            margin: 0 0 1rem 0;
            color: var(--color-primary);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: 400;
            font-size: 0.85rem;
        }

        .price-input {
            position: relative;
        }

        .price-input input {
            padding-right: 2rem;
        }

        .price-input::after {
            content: "‚Ç¨";
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
            pointer-events: none;
        }

        .generate-btn {
            width: 100%;
            padding: 1rem;
            background: var(--color-accent-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 1rem;
        }

        .generate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading-text {
            display: none;
        }

        .pdf-actions {
            display: none;
            background: #f0f9ff;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            text-align: center;
        }

        .pdf-actions.show {
            display: block;
        }

        .pdf-btn {
            background: var(--color-success);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin: 0 0.5rem;
            transition: opacity 0.3s ease;
        }

        .pdf-btn:hover {
            opacity: 0.9;
        }

        .contract-preview {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            border: 1px dashed var(--color-border);
            text-align: center;
            color: var(--color-text-secondary);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }

        /* PDF styles - hidden from screen */
        .pdf-content {
            display: none;
            background: white;
            padding: 40px;
            font-family: Arial, sans-serif;
            font-size: 11px;
            line-height: 1.4;
            color: #333;
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }

        .pdf-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .pdf-company-info {
            text-align: right;
            font-size: 10px;
        }

        .pdf-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 30px 0;
            color: #333;
        }

        .pdf-section {
            margin-bottom: 20px;
        }

        .pdf-section h4 {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #667eea;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .pdf-table th,
        .pdf-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .pdf-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .pdf-footer {
            position: fixed;
            bottom: 20px;
            left: 40px;
            right: 40px;
            text-align: center;
            font-size: 8px;
            color: #666;
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <div class="logo">MT</div>
                <div class="header-text">
                    <h1 id="contractTitle">Vertrag erstellen</h1>
                    <p>Bitte f√ºllen Sie alle Felder sorgf√§ltig aus</p>
                </div>
            </div>
            <a href="admin-contracts.html" class="back-btn">‚Üê Zur√ºck</a>
        </div>

        <div class="form-container">
            <form id="contractForm">
                <!-- Kunde/Model Daten -->
                <div class="form-section">
                    <h3>üë§ Kunde / Model Daten</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientFirstName">Vorname *</label>
                            <input type="text" id="clientFirstName" name="clientFirstName" required maxlength="30">
                        </div>
                        <div class="form-group">
                            <label for="clientLastName">Nachname *</label>
                            <input type="text" id="clientLastName" name="clientLastName" required maxlength="30">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientEmail">E-Mail *</label>
                            <input type="email" id="clientEmail" name="clientEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">Telefon</label>
                            <input type="tel" id="clientPhone" name="clientPhone" maxlength="20">
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="clientAddress">Adresse *</label>
                        <textarea id="clientAddress" name="clientAddress" required maxlength="200" placeholder="Stra√üe, Hausnummer, PLZ, Ort"></textarea>
                    </div>
                </div>

                <!-- Shooting Details -->
                <div class="form-section">
                    <h3>üìÖ Shooting Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shootingDate">Datum *</label>
                            <input type="date" id="shootingDate" name="shootingDate" required>
                        </div>
                        <div class="form-group">
                            <label for="shootingTime">Uhrzeit</label>
                            <input type="time" id="shootingTime" name="shootingTime">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="duration">Dauer (Stunden)</label>
                            <select id="duration" name="duration">
                                <option value="1">1 Stunde</option>
                                <option value="2">2 Stunden</option>
                                <option value="3">3 Stunden</option>
                                <option value="4">4 Stunden</option>
                                <option value="6">6 Stunden</option>
                                <option value="8">8 Stunden</option>
                                <option value="custom">Individuell</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="location">Location *</label>
                            <input type="text" id="location" name="location" required maxlength="100" placeholder="Studio, Outdoor, Adresse...">
                        </div>
                    </div>
                </div>

                <!-- Vertragsspezifische Felder -->
                <div class="form-section" id="contractSpecific">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>

                <!-- Konditionen -->
                <div class="form-section">
                    <h3>üí∞ Konditionen</h3>
                    <div class="form-row" id="priceSection">
                        <div class="form-group">
                            <label for="totalPrice">Gesamtpreis</label>
                            <div class="price-input">
                                <input type="number" id="totalPrice" name="totalPrice" min="0" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Zahlungsweise</label>
                            <select id="paymentMethod" name="paymentMethod">
                                <option value="cash">Bar</option>
                                <option value="transfer">√úberweisung</option>
                                <option value="partial">Teilzahlung</option>
                                <option value="tfp">TFP (kostenfrei)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="additionalCosts">Zus√§tzliche Kosten / Anmerkungen</label>
                        <textarea id="additionalCosts" name="additionalCosts" maxlength="300" placeholder="z.B. Anfahrt, Equipment, Nachbearbeitung..."></textarea>
                    </div>
                </div>

                <!-- Zus√§tzliche Vereinbarungen -->
                <div class="form-section">
                    <h3>üìù Zus√§tzliche Vereinbarungen</h3>
                    <div class="form-group">
                        <label for="additionalNotes">Besondere W√ºnsche / Vereinbarungen</label>
                        <textarea id="additionalNotes" name="additionalNotes" maxlength="500" placeholder="Individuelle W√ºnsche, besondere Anforderungen, etc."></textarea>
                    </div>
                </div>

                <div class="contract-preview">
                    <p>üìã Nach dem Ausf√ºllen wird Ihr professioneller Vertrag als PDF generiert</p>
                </div>

                <button type="submit" class="generate-btn" id="generateBtn">
                    <span class="default-text">PDF Vertrag erstellen</span>
                    <span class="loading-text">PDF wird erstellt...</span>
                </button>

                <div class="pdf-actions" id="pdfActions">
                    <p><strong>‚úÖ PDF erfolgreich erstellt!</strong></p>
                    <button type="button" class="pdf-btn" onclick="downloadPDF()">üì• PDF herunterladen</button>
                    <button type="button" class="pdf-btn" onclick="copyPDFLink()">üîó Link kopieren</button>
                    <button type="button" class="pdf-btn" onclick="createNewContract()">‚ûï Neuen Vertrag erstellen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PDF Content (hidden) -->
    <div class="pdf-content" id="pdfContent">
        <!-- PDF content will be generated here -->
    </div>

    <script>
        // Pr√ºfung ob eingeloggt
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'admin-login.html';
        }

        // Contract type from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const contractType = urlParams.get('type') || 'tfp';
        let contractData = {};
        let pdfBlob = null;

        // Contract configurations
        const contractConfigs = {
            tfp: {
                title: 'TFP Vertrag (Time for Print)',
                icon: 'üì∏',
                specificFields: `
                    <h3>üì∏ TFP Vereinbarung</h3>
                    <div class="form-group">
                        <label>Bildanzahl f√ºr Model *</label>
                        <select name="imageCount" required>
                            <option value="">Ausw√§hlen...</option>
                            <option value="5">5 bearbeitete Bilder</option>
                            <option value="10">10 bearbeitete Bilder</option>
                            <option value="15">15 bearbeitete Bilder</option>
                            <option value="20">20 bearbeitete Bilder</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nutzungsrechte Model</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="modelRights" value="social">
                                <label>Social Media (privat)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="modelRights" value="portfolio">
                                <label>Portfolio/Sedcard</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="modelRights" value="commercial">
                                <label>Kommerzielle Nutzung</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nutzungsrechte Fotograf</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="photographerRights" value="portfolio" checked>
                                <label>Portfolio</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="photographerRights" value="social">
                                <label>Social Media</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="photographerRights" value="website">
                                <label>Website</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="photographerRights" value="marketing">
                                <label>Marketing/Werbung</label>
                            </div>
                        </div>
                    </div>
                `
            },
            wedding: {
                title: 'Hochzeitsvertrag',
                icon: 'üíí',
                specificFields: `
                    <h3>üíí Hochzeitsdetails</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="partnerName">Partner/in Name</label>
                            <input type="text" name="partnerName" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="weddingVenue">Hochzeitslocation *</label>
                            <input type="text" name="weddingVenue" required maxlength="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Leistungspaket *</label>
                        <select name="weddingPackage" required>
                            <option value="">Ausw√§hlen...</option>
                            <option value="basic">Basic (4h, 50 Bilder)</option>
                            <option value="standard">Standard (6h, 100 Bilder)</option>
                            <option value="premium">Premium (8h, alle Bilder)</option>
                            <option value="custom">Individuell</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Zus√§tzliche Services</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="weddingExtras" value="engagement">
                                <label>Verlobungsshooting</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="weddingExtras" value="album">
                                <label>Hochzeitsalbum</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="weddingExtras" value="drone">
                                <label>Drohnenaufnahmen</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="weddingExtras" value="video">
                                <label>Videografie</label>
                            </div>
                        </div>
                    </div>
                `
            },
            business: {
                title: 'Business Shooting Vertrag',
                icon: 'üíº',
                specificFields: `
                    <h3>üíº Business Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyName">Unternehmen</label>
                            <input type="text" name="companyName" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="businessType">Art des Shootings *</label>
                            <select name="businessType" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="headshots">Mitarbeiterportraits</option>
                                <option value="corporate">Corporate Shooting</option>
                                <option value="products">Produktfotografie</option>
                                <option value="events">Firmenevents</option>
                                <option value="architecture">Architektur</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Nutzungsrechte *</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="businessRights" value="website" required>
                                <label>Website</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="businessRights" value="social">
                                <label>Social Media</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="businessRights" value="print">
                                <label>Printmedien</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="businessRights" value="advertising">
                                <label>Werbung</label>
                            </div>
                        </div>
                    </div>
                `
            },
            portrait: {
                title: 'Portrait Shooting Vertrag',
                icon: 'üë§',
                specificFields: `
                    <h3>üë§ Portrait Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="portraitType">Art des Portraits *</label>
                            <select name="portraitType" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="individual">Einzelportrait</option>
                                <option value="couple">Paarportrait</option>
                                <option value="group">Gruppenportrait</option>
                                <option value="family">Familienportrait</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="portraitStyle">Stil *</label>
                            <select name="portraitStyle" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="studio">Studio</option>
                                <option value="outdoor">Outdoor</option>
                                <option value="lifestyle">Lifestyle</option>
                                <option value="classic">Klassisch</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="imageDelivery">Bildlieferung *</label>
                        <select name="imageDelivery" required>
                            <option value="">Ausw√§hlen...</option>
                            <option value="digital">Digital (Download-Link)</option>
                            <option value="usb">USB-Stick</option>
                            <option value="prints">Prints + Digital</option>
                        </select>
                    </div>
                `
            },
            event: {
                title: 'Event Fotografie Vertrag',
                icon: 'üéâ',
                specificFields: `
                    <h3>üéâ Event Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eventType">Art der Veranstaltung *</label>
                            <select name="eventType" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="party">Private Feier</option>
                                <option value="corporate">Firmenevent</option>
                                <option value="conference">Konferenz</option>
                                <option value="concert">Konzert/Show</option>
                                <option value="sport">Sportevent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="guestCount">Anzahl G√§ste (ca.)</label>
                            <input type="number" name="guestCount" min="1" max="1000">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Besondere Anforderungen</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" name="eventExtras" value="discrete">
                                <label>Diskrete Arbeitsweise</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="eventExtras" value="flash">
                                <label>Blitzlicht erlaubt</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" name="eventExtras" value="livestream">
                                <label>Live-√úbertragung</label>
                            </div>
                        </div>
                    </div>
                `
            },
            family: {
                title: 'Familien Shooting Vertrag',
                icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                specificFields: `
                    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familien Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="familySize">Anzahl Personen *</label>
                            <select name="familySize" required>
                                <option value="">Ausw√§hlen...</option>
                                <option value="2">2 Personen</option>
                                <option value="3">3 Personen</option>
                                <option value="4">4 Personen</option>
                                <option value="5">5 Personen</option>
                                <option value="6+">6+ Personen</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="childrenAges">Alter der Kinder</label>
                            <input type="text" name="childrenAges" maxlength="50" placeholder="z.B. 3, 7, 12 Jahre">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="familyStyle">Shooting-Stil *</label>
                        <select name="familyStyle" required>
                            <option value="">Ausw√§hlen...</option>
                            <option value="natural">Nat√ºrlich/Spontan</option>
                            <option value="posed">Gestellt/Formal</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="playful">Verspielt/Kreativ</option>
                        </select>
                    </div>
                `
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeContractForm();
        });

        function initializeContractForm() {
            const config = contractConfigs[contractType];
            if (!config) {
                alert('Unbekannter Vertragstyp');
                window.location.href = 'admin-contracts.html';
                return;
            }

            // Update page title and header
            document.getElementById('contractTitle').innerHTML = `${config.icon} ${config.title}`;
            document.title = `${config.title} - Mark Tietz Fotografie`;

            // Insert specific form fields
            document.getElementById('contractSpecific').innerHTML = config.specificFields;

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('shootingDate').setAttribute('min', today);

            // Handle TFP price hiding
            if (contractType === 'tfp') {
                document.getElementById('priceSection').style.display = 'none';
            }
        }

        // Form submission
        document.getElementById('contractForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generatePDF();
        });

        function generatePDF() {
            const btn = document.getElementById('generateBtn');
            const defaultText = btn.querySelector('.default-text');
            const loadingText = btn.querySelector('.loading-text');

            // Show loading state
            btn.disabled = true;
            defaultText.style.display = 'none';
            loadingText.style.display = 'inline';

            // Collect form data
            const formData = new FormData(document.getElementById('contractForm'));
            contractData = Object.fromEntries(formData.entries());

            // Collect checkbox groups
            const checkboxGroups = ['modelRights', 'photographerRights', 'weddingExtras', 'businessRights', 'eventExtras'];
            checkboxGroups.forEach(group => {
                const checkboxes = document.querySelectorAll(`input[name="${group}"]:checked`);
                contractData[group] = Array.from(checkboxes).map(cb => cb.value);
            });

            // Generate PDF content
            setTimeout(() => {
                try {
                    createPDFContent();
                    generatePDFFile();
                    
                    // Show success state
                    defaultText.style.display = 'inline';
                    loadingText.style.display = 'none';
                    btn.disabled = false;
                    
                    document.getElementById('pdfActions').classList.add('show');
                } catch (error) {
                    console.error('PDF generation error:', error);
                    alert('Fehler beim Erstellen der PDF. Bitte versuchen Sie es erneut.');
                    
                    defaultText.style.display = 'inline';
                    loadingText.style.display = 'none';
                    btn.disabled = false;
                }
            }, 1500);
        }

        function createPDFContent() {
            const config = contractConfigs[contractType];
            const currentDate = new Date().toLocaleDateString('de-DE');
            
            let specificContent = '';
            
            // Generate type-specific content
            switch(contractType) {
                case 'tfp':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>TFP Vereinbarung</h4>
                            <p><strong>Bildanzahl f√ºr Model:</strong> ${contractData.imageCount} bearbeitete Bilder</p>
                            <p><strong>Nutzungsrechte Model:</strong> ${contractData.modelRights ? contractData.modelRights.join(', ') : 'Keine ausgew√§hlt'}</p>
                            <p><strong>Nutzungsrechte Fotograf:</strong> ${contractData.photographerRights ? contractData.photographerRights.join(', ') : 'Portfolio'}</p>
                        </div>
                    `;
                    break;
                case 'wedding':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Hochzeitsdetails</h4>
                            <p><strong>Partner/in:</strong> ${contractData.partnerName || 'Nicht angegeben'}</p>
                            <p><strong>Hochzeitslocation:</strong> ${contractData.weddingVenue}</p>
                            <p><strong>Leistungspaket:</strong> ${contractData.weddingPackage}</p>
                            <p><strong>Zus√§tzliche Services:</strong> ${contractData.weddingExtras ? contractData.weddingExtras.join(', ') : 'Keine'}</p>
                        </div>
                    `;
                    break;
                case 'business':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Business Details</h4>
                            <p><strong>Unternehmen:</strong> ${contractData.companyName || 'Nicht angegeben'}</p>
                            <p><strong>Art des Shootings:</strong> ${contractData.businessType}</p>
                            <p><strong>Nutzungsrechte:</strong> ${contractData.businessRights ? contractData.businessRights.join(', ') : 'Keine ausgew√§hlt'}</p>
                        </div>
                    `;
                    break;
                case 'portrait':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Portrait Details</h4>
                            <p><strong>Art des Portraits:</strong> ${contractData.portraitType}</p>
                            <p><strong>Stil:</strong> ${contractData.portraitStyle}</p>
                            <p><strong>Bildlieferung:</strong> ${contractData.imageDelivery}</p>
                        </div>
                    `;
                    break;
                case 'event':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Event Details</h4>
                            <p><strong>Art der Veranstaltung:</strong> ${contractData.eventType}</p>
                            <p><strong>Anzahl G√§ste:</strong> ${contractData.guestCount || 'Nicht angegeben'}</p>
                            <p><strong>Besondere Anforderungen:</strong> ${contractData.eventExtras ? contractData.eventExtras.join(', ') : 'Keine'}</p>
                        </div>
                    `;
                    break;
                case 'family':
                    specificContent = `
                        <div class="pdf-section">
                            <h4>Familien Details</h4>
                            <p><strong>Anzahl Personen:</strong> ${contractData.familySize}</p>
                            <p><strong>Alter der Kinder:</strong> ${contractData.childrenAges || 'Nicht angegeben'}</p>
                            <p><strong>Shooting-Stil:</strong> ${contractData.familyStyle}</p>
                        </div>
                    `;
                    break;
            }

            const pdfContent = `
                <div class="pdf-header">
                    <div>
                        <div class="pdf-logo">MT</div>
                    </div>
                    <div class="pdf-company-info">
                        <strong>Mark Tietz</strong><br>
                        K√∂nigpl. 3<br>
                        87448 Waltenhofen<br><br>
                        Tel: 01741632129<br>
                        E-Mail: mark.briehn@web.de<br>
                        Web: mark-tietz.de<br><br>
                        Steuernr: 127/280/90241<br>
                        Inhaber: Mark Tietz
                    </div>
                </div>

                <div class="pdf-title">${config.title}</div>

                <div class="pdf-section">
                    <h4>Kundendaten</h4>
                    <p><strong>Name:</strong> ${contractData.clientFirstName} ${contractData.clientLastName}</p>
                    <p><strong>E-Mail:</strong> ${contractData.clientEmail}</p>
                    <p><strong>Telefon:</strong> ${contractData.clientPhone || 'Nicht angegeben'}</p>
                    <p><strong>Adresse:</strong> ${contractData.clientAddress}</p>
                </div>

                <div class="pdf-section">
                    <h4>Shooting Details</h4>
                    <table class="pdf-table">
                        <tr>
                            <td><strong>Datum:</strong></td>
                            <td>${new Date(contractData.shootingDate).toLocaleDateString('de-DE')}</td>
                        </tr>
                        <tr>
                            <td><strong>Uhrzeit:</strong></td>
                            <td>${contractData.shootingTime || 'Nach Vereinbarung'}</td>
                        </tr>
                        <tr>
                            <td><strong>Dauer:</strong></td>
                            <td>${contractData.duration} Stunde(n)</td>
                        </tr>
                        <tr>
                            <td><strong>Location:</strong></td>
                            <td>${contractData.location}</td>
                        </tr>
                    </table>
                </div>

                ${specificContent}

                ${contractType !== 'tfp' ? `
                <div class="pdf-section">
                    <h4>Konditionen</h4>
                    <table class="pdf-table">
                        <tr>
                            <td><strong>Gesamtpreis:</strong></td>
                            <td>${contractData.totalPrice ? contractData.totalPrice + ' ‚Ç¨' : 'Nach Vereinbarung'}</td>
                        </tr>
                        <tr>
                            <td><strong>Zahlungsweise:</strong></td>
                            <td>${getPaymentMethodText(contractData.paymentMethod)}</td>
                        </tr>
                    </table>
                    ${contractData.additionalCosts ? `<p><strong>Zus√§tzliche Kosten:</strong> ${contractData.additionalCosts}</p>` : ''}
                </div>
                ` : ''}

                ${contractData.additionalNotes ? `
                <div class="pdf-section">
                    <h4>Zus√§tzliche Vereinbarungen</h4>
                    <p>${contractData.additionalNotes}</p>
                </div>
                ` : ''}

                <div class="pdf-section">
                    <h4>Allgemeine Bedingungen</h4>
                    <p style="font-size: 9px; line-height: 1.3;">
                        1. Dieser Vertrag regelt die Zusammenarbeit zwischen dem Fotografen Mark Tietz und dem oben genannten Kunden.<br>
                        2. Terminverschiebungen sind bis 48h vor dem Shooting kostenfrei m√∂glich.<br>
                        3. Bei Ausfall durch h√∂here Gewalt (Wetter, Krankheit) wird ein Ersatztermin vereinbart.<br>
                        4. Die Bildbearbeitung erfolgt nach k√ºnstlerischem Ermessen des Fotografen.<br>
                        5. Nutzungsrechte werden gem√§√ü den oben vereinbarten Bedingungen √ºbertragen.<br>
                        6. Der Fotograf beh√§lt sich das Recht vor, Bilder f√ºr eigene Werbezwecke zu verwenden, sofern nicht anders vereinbart.
                    </p>
                </div>

                <div style="margin-top: 40px;">
                    <table style="width: 100%;">
                        <tr>
                            <td style="width: 50%; border-top: 1px solid #333; text-align: center; padding-top: 5px;">
                                <small>Datum, Unterschrift Kunde</small>
                            </td>
                            <td style="width: 50%; border-top: 1px solid #333; text-align: center; padding-top: 5px;">
                                <small>Datum, Unterschrift Mark Tietz</small>
                            </td>
                        </tr>
                    </table>
                </div>

                <div class="pdf-footer">
                    <strong>Mark Tietz Fotografie</strong> | K√∂nigpl. 3, 87448 Waltenhofen | Tel: 01741632129 | mark.briehn@web.de<br>
                    Steuernummer: 127/280/90241 | Bankverbindung: Postbank Ndl der Deutsche Bank | IBAN: DE56 1001 0010 0776 3691 14 | BIC: PBNK DEFF XXX<br>
                    Erstellt am: ${currentDate}
                </div>
            `;

            document.getElementById('pdfContent').innerHTML = pdfContent;
        }

        function generatePDFFile() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const element = document.getElementById('pdfContent');
            element.style.display = 'block';

            // Convert HTML to PDF using html2canvas and jsPDF
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                // Generate blob for download
                pdfBlob = pdf.output('blob');
                
                element.style.display = 'none';
            });
        }

        function getPaymentMethodText(method) {
            const methods = {
                'cash': 'Bar',
                'transfer': '√úberweisung',
                'partial': 'Teilzahlung',
                'tfp': 'TFP (kostenfrei)'
            };
            return methods[method] || method;
        }

        function downloadPDF() {
            if (pdfBlob) {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(pdfBlob);
                link.download = `${contractConfigs[contractType].title}_${contractData.clientLastName}_${new Date().toISOString().split('T')[0]}.pdf`;
                link.click();
            }
        }

        function copyPDFLink() {
            // In a real implementation, you would upload the PDF to a server and get a shareable link
            // For now, we'll just show a placeholder
            const link = `https://mark-tietz.de/contracts/view/${Date.now()}`;
            navigator.clipboard.writeText(link).then(() => {
                alert('Link wurde in die Zwischenablage kopiert!\n\nHinweis: Dies ist ein Beispiel-Link. In der finalen Version w√ºrde hier ein echter Download-Link generiert.');
            });
        }

        function createNewContract() {
            if (confirm('M√∂chten Sie wirklich einen neuen Vertrag erstellen? Alle aktuellen Eingaben gehen verloren.')) {
                window.location.reload();
            }
        }
    </script>
</body>
</html> 